
const defaultField = { value: '', type: 'text/plain' }

function parseContentDisposition(segment, field) {
  let startPos = segment.indexOf('Content-Disposition')

  if (~startPos) {
    let m_name = segment.match(/name="(\w+)"/)
    let m_filename = segment.match(/filename="(.+?)"/)

    if (m_name) {
      field.name = m_name[1]
    }

    if (m_filename) {
      field.filename = m_filename[1]
    }
  }
}

function parseContentType(segment, field) {
  let startPos = segment.indexOf('Content-Type')

  if (~startPos) {
    let m_mine = segment.match(/Content-Type:\s(.+?)\r\n/)

    if (m_mine) {
      field.type = m_mine[1]
    }
  }
}

function parseContent(segment, field) {
  let startChars = '\r\n\r\n'
  let startPos = segment.indexOf(startChars)

  if (~startPos) {
    field.value = segment.substring(startPos + startChars.length, segment.lastIndexOf('\r\n'))
  } else {
    field.value = ''
  }
}

module.exports = function formDataHandler(req, res, next) {
  let fields = {}

  if (req.rawBody) {
    let seq = req.rawBody.substr(0, req.rawBody.indexOf('\r\n'))
    let segments = req.rawBody.split(seq + '\r\n')

    segments[segments.length - 1] = segments[segments.length - 1].replace(seq + '--\r\n', '')

    for (let segment of segments) {
      if (segment.startsWith('Content-Disposition')) {

        let field = {}
        parseContentDisposition(segment, field)
        parseContentType(segment, field)
        parseContent(segment, field)

        if (field.name) {
          fields[field.name] = field
        }
      }
    }


    // 解析
    // for (let key in fields) {
    //   let field = fields[key]

    //   if (field.type == '') {

    //   }
    // }

    // let rows = req.rawBody.split('\r\n')
    // let i = 0
    // let field 

    // // 获得字段
    // while(i < rows.length){
    //   let content = rows[i]

    //   if(!content || content.indexOf('------WebKitFormBoundary') == 0) {
    //     // nothing
    //   }
    //   else if(content.indexOf('Content-Disposition:') ==0){
    //     const m_name = content.match(/name="(\w+)"/)
    //     const m_fieldname = content.match(/filename="(.+?)"/)

    //     if(m_name){
    //       fields[m_name[1]] = field = Object.create(defaultField)
    //       field.value = ''
    //     }

    //     if(m_fieldname){
    //       field.fieldname = m_fieldname[1]
    //     }
    //   }else if(content.indexOf('Content-Type:') ==0){
    //     if(field) field.type = content.replace('Content-Type: ','')
    //   }else{
    //     if(field) field.value += content
    //   }

    //   i++
    // }

    // // 解析
    // for(let key in fields){
    //   let field = fields[key]

    //   if(field.type == ''){

    //   }
    // }
  }

  req.body = fields

  next()
}